<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>quick_take</title>
    <style>
      /* --- Layout --- */
      html, body {
        margin: 0;
        height: 100%;
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
      }

      header {
        background: #222;
        color: #fff;
        padding: 0.8rem 1rem;
        flex: 0 0 auto;
      }

      main {
        flex: 1 1 auto;
        overflow: auto;
        padding: 1rem;
        background: #f5f5f5;
      }

      footer {
        background: #ddd;
        padding: 0.8rem 1rem;
        flex: 0 0 auto;
        display: flex;
        justify-content: space-between;
      }

      /* Non-blocking messages */
      #messages {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 300px;
        z-index: 1000;
        pointer-events: none;
      }

      .msg {
        background: #323232;
        color: #fff;
        padding: 0.7rem 1rem;
        margin-bottom: 0.5rem;
        border-radius: 4px;
        opacity: 0.95;
        font-size: 0.9rem;
        transition: opacity 0.5s linear;
      }

      .msg.success { background:#4caf50; }
      .msg.error   { background:#f44336; }

      /* Modal styles */
      #modalOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }

      #modal {
        background: #fff;
        max-width: 90%;
        max-height: 80%;
        overflow: auto;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      }

      #modal button.close {
        background:#f44336;
        color:#fff;
        border:none;
        padding:0.4rem 0.8rem;
        border-radius:4px;
        cursor:pointer;
        float:right;
      }

      /* --- Buttons --- */
      button {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        cursor: pointer;
        border: none;
        border-radius: 4px;
      }

      #quickTakeBtn { background: #4CAF50; color: #fff; }
      #panicExitBtn  { background: #f44336; color: #fff; }

      /* Simple area to show board JSON */
      pre {
        white-space: pre-wrap;
        word-break: break-all;
        background: #fff;
        border: 1px solid #ccc;
        padding: 1rem;
        border-radius: 4px;
      }

      table.board {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
      }

      table.board th, table.board td {
        border: 1px solid #ccc;
        padding: 0.4rem 0.6rem;
        text-align: right;
        font-family: monospace;
      }

      table.board th {
        background: #e0e0e0;
      }

      .highlight {
        background: #ffff66; /* pale yellow */
      }

      /* separator between sell and buy */
      tr.separator td {
        border-top: 4px solid #000;
      }
    </style>
  </head>
  <body>
    <header>
      <h1 style="margin:0">quick_take</h1>
    </header>

    <main>
      <h2>Board</h2>
      <div id="board">Loading board...</div>
    </main>

    <div id="messages"></div>

    <!-- Modal for detailed JSON -->
    <div id="modalOverlay">
      <div id="modal">
        <button class="close">Close</button>
        <pre id="modalContent"></pre>
      </div>
    </div>

    <footer>
      <button id="quickTakeBtn">quick_take</button>
      <button id="panicExitBtn">panic_exit</button>
    </footer>

    <script>
      // Default symbol used for quick_take and board RPC calls.
      const DEFAULT_SYMBOL = "1459";

      // ---------- RPC Helpers ----------
      function postRpc(path, payload) {
        return fetch(`/kabue/rpc/${path}` , {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        }).then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        });
      }

      // ---------- Board Refresh ----------
      const boardContainer = document.getElementById("board");

      function buildBoardTable(board, changedKeys = new Set()) {
        // Extract rows {side, level, time, price}
        const rowsMap = {};
        Object.entries(board || {}).forEach(([key, value]) => {
          const m = key.match(/^(buy|sell)(\d*)_(time|price|qty)$/i);
          if (!m) return;
          const side = m[1].toLowerCase();
          const levelStr = m[2] || "";
          let attr = m[3].toLowerCase();
          if (attr === "qty") attr = "volume";
          const id = side + levelStr;
          if (!rowsMap[id]) rowsMap[id] = {side, level: levelStr || ""};
          rowsMap[id][attr] = value;
        });

        const rows = Object.values(rowsMap);
        rows.sort((a,b)=>{
          if (a.side === b.side) {
            const na = parseInt(a.level||0,10);
            const nb = parseInt(b.level||0,10);
            if (a.side === "sell") {
              return nb - na; // sell rows descending
            } else {
              return na - nb; // buy rows ascending
            }
          }
          return a.side === "sell" ? -1 : 1; // sell rows first
        });

        const table = document.createElement("table");
        table.className = "board";

        const thead = document.createElement("thead");
        thead.innerHTML = `<tr><th>Price</th><th>Volume</th><th>Side</th><th>Level</th><th>Time</th></tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        rows.forEach((r, idx) => {
          const tr = document.createElement("tr");
          if (idx > 0 && rows[idx-1].side !== r.side) {
            tr.classList.add("separator");
          }

          // Helper to build td and highlight if changed
          function cellHtml(value, boardKey) {
            const td = document.createElement("td");
            td.textContent = value === undefined ? "" : value;
            if (changedKeys.has(boardKey)) {
              td.classList.add("highlight");
              setTimeout(() => td.classList.remove("highlight"), 1000);
            }
            return td;
          }

          // board keys for each cell
          const priceKey = `${r.side}${r.level}_price`;
          const volKey = `${r.side}${r.level}_qty`;
          const timeKey = `${r.side}${r.level}_time`;

          tr.appendChild(cellHtml(r.price, priceKey));
          tr.appendChild(cellHtml(r.volume, volKey));
          tr.appendChild(cellHtml(r.side, "")); // side changes not highlighted
          tr.appendChild(cellHtml(r.level, ""));
          tr.appendChild(cellHtml(r.time, timeKey));

          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        return table;
      }

      let prevBoard = {};
      let refreshHandle;

      function scheduleNext(ms) {
        if (refreshHandle) clearTimeout(refreshHandle);
        refreshHandle = setTimeout(refreshBoard, ms);
      }

      function refreshBoard() {
        postRpc("board", {symbol: DEFAULT_SYMBOL})
          .then(data => {
            const currentBoard = data.board || {};

            // detect changes
            const changedKeys = new Set();
            Object.entries(currentBoard).forEach(([k,v]) => {
              if (prevBoard[k] !== v) changedKeys.add(k);
            });

            boardContainer.innerHTML = "";
            const table = buildBoardTable(currentBoard, changedKeys);
            boardContainer.appendChild(table);

            prevBoard = currentBoard; // update after rendering

            // adjust refresh cadence
            const intervalMs = data.is_ws_data ? 1000 : 10000;
            scheduleNext(intervalMs);
          })
          .catch(err => {
            boardContainer.textContent = `Error fetching board: ${err}`;
            scheduleNext(10000); // backoff on error
          });
      }

      // initial fetch
      refreshBoard();

      // ---------- Button Actions ----------
      const msgContainer = document.getElementById("messages");

      function showMessage(text, type = "success") {
        const div = document.createElement("div");
        div.className = `msg ${type}`;
        div.textContent = text;
        msgContainer.appendChild(div);
        // fade out and remove after 4s
        setTimeout(() => {
          div.style.opacity = 0;
          setTimeout(() => msgContainer.removeChild(div), 500);
        }, 4000);
      }

      const modalOverlay = document.getElementById("modalOverlay");
      const modalContent = document.getElementById("modalContent");
      modalOverlay.querySelector("button.close").addEventListener("click", () => {
        modalOverlay.style.display = "none";
      });

      function showModal(dataObj) {
        modalContent.textContent = JSON.stringify(dataObj, null, 2);
        modalOverlay.style.display = "flex";
      }

      document.getElementById("quickTakeBtn").addEventListener("click", () => {
        postRpc("quick_take", {symbol: DEFAULT_SYMBOL})
          .then(data => {
            showMessage("quick_take succeeded", "success");
          })
          .catch(err => {
            showMessage("quick_take failed: " + err, "error");
          });
      });

      document.getElementById("panicExitBtn").addEventListener("click", () => {
        postRpc("panic_exit", {})
          .then((data) => {
            if (data && data.success) {
              showMessage("panic_exit succeeded", "success");
            } else {
              showModal(data);
            }
          })
          .catch(err => {
            showMessage("panic_exit failed: " + err, "error");
          });
      });
    </script>
  </body>
</html>
